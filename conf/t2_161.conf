# SPDX-License-Identifier: MIT
# (C) 2022 The Asahi Linux Contributors

context.properties = {
    log.level = 0
    default.clock.rate = 48000
    default.clock.allowed-rates = [ 44100 48000 88200 96000 ]
}

context.spa-libs = {
    audio.convert.* = audioconvert/libspa-audioconvert
    support.*       = support/libspa-support
}


context.modules = [
    { name = libpipewire-module-filter-chain
        args = {
            node.description = "MacBook Pro J31x Speakers"
            media.name       = "MacBook Pro J31x Speakers"
            filter.graph = {
                nodes = [
                    { type = lv2
                      name = comp
                      plugin = "http://lsp-plug.in/plugins/lv2/mb_compressor_stereo"
                      control = {
                        mode = 1 #"Modern"
                        envb = 1 #Envelope boost
                        bsel = 0 #Band selection 0.0-8.0 def 0.0
                        flt = 1 #Band filter curves 0.0-1.0 def 1.0
                        cbe_2 = 1 #Compression band enable 2 0-1 default 0
                        sf_2 = 140 #Split frequency 2. 10-2000 def 100
                        cm_0 = 0 #Sidechain mode 0. 0.0-3.0 def 1.0
                        ce_0 = 1 #Compressor enable 0. 0-1
                        al_0 = 0.25119 #Attack threshold 0. 1-0
                        at_0 = 0 #Attack time 0
                        rrl_0 = 0 #Release threshold 0
                        rt_0 = 30 #Release time 0
                        cr_0 = 3.5 #Ratio 0
                        kn_0 = 0.0631 #Knee 0
                        cm_1 = 0 #Sidechain mode 0. 0.0-3.0 def 1.0
                        ce_2 = 1 #Compressor enable 0. 0-1
                        al_2 = 0.25119 #Attack threshold 0. 1-0
                        at_2 = 0 #Attack time 0
                        rrl_2 = 0 #Release threshold 0
                        rt_2 = 30 #Release time 0
                        cr_2 = 3.5 #Ratio 0
                        kn_2 = 0.0631 #Knee 0
                      }
                    }
                    
                    { type = lv2
                      name = bass
                      plugin = "http://calf.sourceforge.net/plugins/BassEnhancer"
                      control = {
                        bypass = 0
                        level_in = 1.0
                        level_out 1.0
                        amount = 1.1
                        meter_in = 0
                        meter_out = 0
                        clip_in = 0
                        clip_out = 0
                        drive = 8.5
                        blend = 3
                        freq = 150
                        listen = 0
                        floor_active = 1
                        floor = 60
                      }
                    }
                    
                    
                    
                    { type = lv2
                      name = compStereo
                      plugin = "http://lsp-plug.in/plugins/lv2/compressor_stereo"
                      control = {
                        bypass = true# Bypass [boolean]: true/false
                        # Compression mode: 0..2
                        #   0: Down
                        #   1: Up
                        #   2: Boot
                        cm = 0
                        al = -5.0 # Attack threshold [G]: 0.00100000..1.00000000
                        at = 5.25 # Attack time [ms]: 0.00000000..2000.00000000
                        rt = 100.0 # Release time [ms]: 0.00000000..5000.00000000
                        cr = 2.0  # Ratio: 1.00000000..100.00000000
                        kn = -15.6  # Knee [G]: 0.06310000..1.00000000
                        bth = -72.0065  # Boost threshold [G]: 0.000001000000..0.001000000047
                        bsa = 6.0  # Boost signal amount [G]: 0.000251190009..3981.072998046875
                        mk = 3.0  # Makeup gain [G]: 0.00100000..1000.00000000
                      }
                    }
                    
                    
                    # We only need one FIR for each class of driver. The devices
                    # are almost perfectly matched L for R and this setup yields
                    # pretty great results from most listening positions

                    # Left Tweeter
                    {
                        type = builtin
                        label = convolver
                        name = convLT
                        config = {
                            #filename = "/usr/share/pipewire/devices/apple/t2_161/flat-48k.wav"
                            filename = "/usr/share/pipewire/devices/apple/t2_161/macbook_pro_t2_16_1_tweeters-48k_3.wav"
                            channel = 0
                            gain = 1.0
                        }
                    }

                    # Right Tweeter
                    {
                        type = builtin
                        label = convolver
                        name = convRT
                        config = {
                            #filename = "/usr/share/pipewire/devices/apple/t2_161/flat-48k.wav"
                            filename = "/usr/share/pipewire/devices/apple/t2_161/macbook_pro_t2_16_1_tweeters-48k_3.wav"
                            channel = 0
                            gain = 1.0
                        }
                    }

                    # Left Woofer
                    {
                        type = builtin
                        label = convolver
                        name = convLW
                        config = {
                            #filename = "/usr/share/pipewire/devices/apple/t2_161/flat-48k.wav"
                            filename = "/usr/share/pipewire/devices/apple/t2_161/macbook_pro_t2_16_1_woofers-48k_3.wav"
                            channel = 0
                            gain = 1.0
                        }
                    }

                    # Right Woofer
                    {
                        type = builtin
                        label = convolver
                        name = convRW
                        config = {
                            #filename = "/usr/share/pipewire/devices/apple/t2_161/flat-48k.wav"
                            filename = "/usr/share/pipewire/devices/apple/t2_161/macbook_pro_t2_16_1_woofers-48k_3.wav"
                            channel = 0
                            gain = 1.0
                        }
                    }

                    # Left Subwoofer
                    {
                        type = builtin
                        label = convolver
                        name = convLW2
                        config = {
                            #filename = "/usr/share/pipewire/devices/apple/t2_161/flat-48k.wav"
                            filename = "/usr/share/pipewire/devices/apple/t2_161/macbook_pro_t2_16_1_woofers-48k_3.wav"
                            channel = 0
                            gain = 1.0
                        }
                    }

                    # Right Subwoofer
                    {
                        type = builtin
                        label = convolver
                        name = convRW2
                        config = {
                            #filename = "/usr/share/pipewire/devices/apple/t2_161/flat-48k.wav"
                            filename = "/usr/share/pipewire/devices/apple/t2_161/macbook_pro_t2_16_1_woofers-48k_3.wav"
                            channel = 0
                            gain = 1.0
                        }
                    }
                ]

                # Map the inputs to their appropriate convolvers
                links = [
                    
                    { output = "bass:out_l" input = "comp:in_l"}
                    { output = "bass:out_r" input = "comp:in_r"}
                    
                    { output = "comp:out_l" input = "convLT:In"}
                    { output = "comp:out_l" input = "convLW:In"}
                    { output = "comp:out_l" input = "convLW2:In"}
                    { output = "comp:out_r" input = "convRT:In"}
                    { output = "comp:out_r" input = "convRW:In"}
                    { output = "comp:out_r" input = "convRW2:In"}
                ]

               
                inputs = [ "bass:in_l" "bass:in_r" ]
                
                # changed the outputs order
                # following 16,1 2019 model at /System/Library/Audio/Tunings/Mac-E1008331FDC96864/DSP/Graphs/builtin_speaker_out.dspg
                # [def numChansOut 6] ; rdar://46105807; Mapping Ch 0 - Ch 5; Left woofer 1, left woofer 2, left tweeter, right woofer 1, right woofer 2, right tweeter as of 12/03/18
                outputs = [ 
                            "convLW:Out"
                            "convLW2:Out"
                            "convLT:Out"
                            "convRW:Out"
                            "convRW2:Out"
                            "convRT:Out"
                            ]
            }
            capture.props = {
                node.name = "audio_input.j31x-convolver"
                media.class = "Audio/Sink"
                audio.channels = 2
                audio.position = [ FL FR ]
            }

            # Theoretically, this should sink the output straight to the
            # speaker array.
            playback.props = {
                node.target = "alsa_output.platform-sound.pro-output-1"
                node.passive = true
                audio.channels = 6
                audio.position = [ AUX0 AUX1 AUX2 AUX3 AUX4 AUX5 ]
            }
        }
    }
]
